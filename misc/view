#!/bin/sh

# Utility script to view files generated by the compiler of type .cfg
# or .dg .

FILE="$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"

echo "$FILE"

case "$FILE" in

  *.pdf) TYPE=pdf
         ;;
  *.cfg) TYPE=cfg
         ;;
   *.dg) TYPE=dg
         ;;
      *) echo "Usage: $0 file.ext    where ext is one of pdf/cfg/dg"
         exit 1
         ;;

esac

view_file()
{
  if test "$PREV_LAST_MOD" = "" ; then
    if test -e "/Applications/Skim.app" ; then
      osascript -e "tell application \"Skim\" to open \"$1\"" > /dev/null
    else
      if test -e "/System/Applications/Preview.app" ; then
        osascript -e "tell application \"Preview\" to open \"$1\"" > /dev/null
      else
        open "$1"
      fi
    fi
  fi
}

update_view()
{
  case "$TYPE" in

    pdf) view_file "$FILE"
         ;;
    cfg) dot -O -Tpdf "$FILE"
         view_file "$FILE.pdf"
         ;;
     dg) dot -O -Tpdf "$FILE"
         view_file "$FILE.pdf"
         ;;

  esac
}

PREV_LAST_MOD=""

UPDATED="yes"

while true ; do

  if test -e "$FILE" ; then
    LAST_MOD=`date -r "$FILE"`
    if test "$LAST_MOD" != "$PREV_LAST_MOD" ; then
      UPDATED="yes"
      PREV_LAST_MOD="$LAST_MOD"
    else
      if test "$UPDATED" = "yes" ; then
        update_view
      fi
      UPDATED="no"
    fi
  fi

  sleep 1

done
